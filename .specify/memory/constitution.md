# MediaGrabber 專案憲章

**專案定位**：多平台媒體下載工具
**核心目標**：以 CLI 與 Web 介面提供 YouTube、Facebook、Instagram、Twitter/X 等平台的高品質下載與後製流程

## 核心原則

### 一、雙介面等同可用

所有下載功能必須同時支援 CLI 與 Web 介面，並保持功能一致。

**理由**：使用者情境多元。CLI 服務自動化與批次流程，Web 則面向一般使用者；兩者需同樣強大且同步維護。

**實施要點**：

- CLI 指令實作於 `backend/app/` 的服務層與 `main.py` 入口，需具備完整參數解析
- REST API 由 `backend/app/api/` 的路由層提供，須與 CLI 功能對應
- 商業邏輯統一於 `backend/app/services/` 實作，確保 CLI 與 API 調用同一函式庫
- 新功能開發順序：先完成 `backend/app/services/` 核心邏輯，再加上 CLI 包裝，最後補齊 API 端點
- 測試時需確認兩介面在格式、品質選項、錯誤回報上皆保持一致

---

### 二、測試優先且涵蓋真實整合

單元測試使用模擬，整合測試則必須透過真實網路呼叫驗證各平台相容性。

**理由**：真正下載到的檔案必須可以播放。單靠模擬無法捕捉平台 API 變動、格式不相容或登入需求等問題。

**實施要點**：

- **單元測試**（`backend/tests/unit/`）：模擬 YoutubeDL、檔案 I/O 等外部依賴，專注於邏輯驗證
- **整合測試**（`backend/tests/integration/`）：使用實際平台 URL，下載至 `output/` 目錄並檢查是否能播放
- **契約測試**（`backend/tests/contract/`）：驗證 API 與 CLI 介面簽章一致
- **前端測試**（`frontend/tests/`）：單元測試 Svelte 元件與 API 整合
- **測試紀錄**：維護 `backend/TEST_RESULTS.md`，記錄各平台最新測試結果與限制
- **基本覆蓋**：每個次版號至少驗證一次 YouTube 單片、YouTube 播放清單、Facebook、Instagram、Twitter/X

---

### 三、設計簡潔、模組微小

避免過度抽象，優先採用責任明確、易於重構的直接實作。

**理由**：下載流程應維持「解析 URL → 取得資訊 → 下載 → （選擇性）轉碼」。引入過多工廠或管線會提高維護成本，日後更換下載庫（例：yt-dlp）也會更困難。

**實施要點**：

- 依平台或職責（下載 vs 轉碼）拆分模組，而非依設計模式分類
- 函式長度建議 ≤ 50 行，過長時拆解並以具體命名的小函式替代
- 非必要不得新增「Manager」「Handler」等控制類別，除非協調三個以上元件
- 結構化資料使用 dataclass（如 DownloadJob、ProgressState），避免冗長 getter/setter 類別

---

### 四、品質優化採漸進策略

先確保下載成功，再以選配流程提供轉檔與行動裝置最佳化。

**理由**：下載是最核心任務；轉碼（例如 MP3 萃取、行動化檔案）屬於加值功能。分階段實作能降低耦合並易於維護。

**實施要點**：

- **核心下載**：直接輸出平台原始檔（可能是 m4a、webm 等）
- **格式轉換**（m4a → MP3）：以 ffmpeg 後處理，可依平台開關
- **行動轉碼**（檔案大小／位元率最佳化）：獨立管線，透過參數啟用
- 每一階段都須保留中間產物，允許獨立使用或串接

---

### 五、可觀測且易於閱讀

所有流程必須輸出人類可讀的進度與錯誤資訊，方便 CLI 與 Web 顯示。

**理由**：使用者需要知道目前進度、剩餘時間、錯誤原因。純結構化日誌（JSON）不符合互動需求。

**實施要點**：

- 進度回呼需回傳 `status`、`stage`（描述）、`percent`、`downloaded_bytes`、`total_bytes`、`speed`、`eta`
- 錯誤訊息需包含根本原因、建議行動（如「稍後再試」「檢查 URL」）與平台注意事項
- 目前統一使用英文訊息；多語系支援列為未來工作
- 禁止靜默失敗，所有流程需明確回報成功或失敗

---

## 技術標準

### 技術堆疊（固定）

- **後端**：Python 3.10+、Flask 2.0+
- **前端**：Svelte 5、Vite 6、Tailwind CSS
- **媒體函式庫**：yt-dlp（多平台）、pytubefix（YouTube 專用）、ffmpeg 4.0+（轉碼）
- **程式品質**：使用 ruff、pre-commit，函式需具型別註解
- **測試工具**：unittest（Python）＋真實網路整合測試

### 目錄結構（推薦）

```text
project/
│
├─ backend/                       # Python 後端
│   ├─ app/                       # 主程式碼
│   │   ├─ api/                   # API 路由
│   │   ├─ services/              # 商業邏輯
│   │   ├─ models/                # 資料模型
│   │   └─ utils/                 # 工具函式
│   │
│   ├─ tests/                     # 測試程式碼
│   │   ├─ unit/
│   │   ├─ integration/
│   │   └─ contract/
│   │
│   ├─ requirements.txt
│   └─ main.py
│
├─ frontend/                      # 前端（Svelte）
│   ├─ src/
│   ├─ tests/                     # 測試程式碼
│   ├─ public/
│   └─ package.json
│
├─ infra/                         # Infrastructure（可選）
│   ├─ docker/
│   └─ scripts/
│
├─ docker-compose.yml
└─ README.md
```

### 平台支援狀態

| 平台                | 格式     | 函式庫            | 狀態    | 備註                         |
| ------------------- | -------- | ----------------- | ------- | ---------------------------- |
| YouTube（單支影片） | MP3、MP4 | pytubefix 10.3.5+ | ✅ 已測 | 播放清單以個別任務處理       |
| YouTube（播放清單） | MP3、MP4 | pytubefix 10.3.5+ | ✅ 已測 | 逐一下載，預設延遲 3 秒      |
| Facebook            | MP4      | yt-dlp 2025+      | ✅ 已測 | 免登入（可選擇提供 cookies） |
| Instagram（Reel）   | MP4      | yt-dlp 2025+      | ✅ 已測 | 約 5–10 次後可能遇到節流     |
| Twitter/X           | MP4      | yt-dlp 2025+      | ✅ 已測 | 支援影片，不含 GIF           |

---

## 開發流程

### 新功能開發清單

1. ✅ 於 `backend/app/services/` 實作核心邏輯
2. ✅ 撰寫單元測試（`backend/tests/unit/`）並模擬外部依賴
3. ✅ 補齊 CLI 指令（`backend/main.py` 參數解析）
4. ✅ 新增 REST API 端點（`backend/app/api/` 路由）
5. ✅ 撰寫整合測試（`backend/tests/integration/`）驗證平台相容性
6. ✅ 撰寫契約測試（`backend/tests/contract/`）確保介面一致
7. ✅ 更新 README.md（中英文）說明
8. ✅ 若平台支援狀態改變，更新 TEST_RESULTS.md
9. ✅ 執行 `ruff check backend/` 與 pre-commit

### 核心下載邏輯調整

1. 保留相容性：既有 URL 必須仍可使用
2. 新增參數需為選用，並提供合理預設值
3. 對所有平台重新進行整合測試
4. 若不可避免有破壞性變更：提升次版號並撰寫遷移指南

---

## 治理規範

**憲章優先**：任何偏離本文件的作法皆需在 PR 與提交訊息中記錄理由。

**修訂流程**：

1. 撰寫提案與理由說明
2. 取得專案擁有者（Brian Han）核准
3. 於下方〈版本紀錄〉新增條目
4. 同步更新關聯文件（CLAUDE.md、GEMINI.md、README.md）

**遵循檢查**：每次發佈需檢視所有 PR 是否符合原則；若有違規，需延後佈署或先行重構，核心下載流程不得累積技術債。

---

## 版本紀錄

| 版本  | 日期       | 變更內容             | 狀態           |
| ----- | ---------- | -------------------- | -------------- |
| 1.0.0 | 2025-12-02 | 初版憲章草稿         | 草稿（待審核） |
|       |            | - 雙介面等同可用     |                |
|       |            | - 測試優先含真實整合 |                |
|       |            | - 設計簡潔模組微小   |                |
|       |            | - 品質優化採漸進策略 |                |
|       |            | - 可觀測且易於閱讀   |                |

**版本**：1.0.0 | **核准日期**：[待審核] | **最後修訂**：2025-12-02
