<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MediaGrabber Web GUI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* No custom styles for #overlay needed, using Tailwind classes directly */
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen font-sans">
    <div id="overlay" class="hidden fixed inset-0 bg-black/50 z-50 flex justify-center items-center">
      <div class="w-1/2 bg-white p-8 rounded-lg shadow-lg text-center">
        <h2 id="overlayTitle" class="text-2xl font-bold mb-4">Downloading...</h2>
        <div class="w-full">
          <progress
            id="downloadProgress"
            class="w-full"
            value="0"
            max="100"
          ></progress>
          <div id="progressText" class="mt-1 text-sm text-gray-600">0%</div>
        </div>
      </div>
    </div>
    <div class="min-h-screen flex flex-col items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8 font-sans">
      <div class="max-w-md w-full space-y-8">
        <h1 id="pageTitle" class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          MediaGrabber Web GUI
        </h1>
        <div class="bg-white p-8 rounded-lg shadow-lg">
          <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-4" role="tablist">
              <button
                type="button"
                id="tab-youtube"
                class="px-3 py-2 font-medium text-blue-600 border-b-2 border-blue-600 transition-colors duration-200 ease-in-out"
                role="tab"
                aria-selected="true"
              >
                YouTube
              </button>
              <button
                type="button"
                id="tab-facebook"
                class="px-3 py-2 font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 hover:border-gray-300 transition-colors duration-200 ease-in-out"
                role="tab"
                aria-selected="false"
              >
                Facebook
              </button>
              <button
                type="button"
                id="tab-instagram"
                class="px-3 py-2 font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 hover:border-gray-300 transition-colors duration-200 ease-in-out"
                role="tab"
                aria-selected="false"
              >
                Instagram
              </button>
            </nav>
          </div>
          <form id="downloadForm" class="mt-8 space-y-6">
        <div>
          <label
            for="url"
            id="urlLabel"
            class="block text-sm font-medium text-gray-700 mb-1"
            >YouTube URL</label
          >
          <input
            type="text"
            id="url"
            name="url"
            placeholder="https://www.youtube.com/watch?v=..."
            required
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          />
        </div>
        <div id="formatContainer">
          <label class="block text-sm font-medium text-gray-700 mb-2"
            >Download Format</label
          >
          <div class="flex space-x-4 mb-4">
            <label class="flex items-center">
              <input
                type="radio"
                id="format-mp3"
                name="format"
                value="mp3"
                checked
                class="mr-2 text-blue-600 focus:ring-blue-500"
              />
              <span class="text-sm text-gray-700">MP3 (Sound)</span>
            </label>
            <label class="flex items-center">
              <input
                type="radio"
                id="format-mp4"
                name="format"
                value="mp4"
                class="mr-2 text-blue-600 focus:ring-blue-500"
              />
              <span class="text-sm text-gray-700">MP4 (Video)</span>
            </label>
          </div>
        </div>
        <div id="thumbnailContainer" class="mb-4 flex justify-center hidden">
          <img
            id="thumbnailPreview"
            class="max-w-xs rounded shadow"
            src=""
            alt="Video Thumbnail"
          />
        </div>
        <div id="titleContainer" class="mb-4 text-center hidden">
          <h2
            id="titlePreview"
            class="text-xl font-semibold text-gray-800"
          ></h2>
        </div>
        <button
          type="submit"
          id="downloadBtn"
          class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 ease-in-out"
        >
          Download
        </button>
        <button
          type="button"
          id="clearBtn"
          class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors duration-200 ease-in-out"
        >
          Clear
        </button>
      </form>
      <div id="message" class="mt-4 text-center text-gray-700 text-sm"></div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Cache DOM elements for better performance and readability.
        var activeTab = "youtube";
        var tabButtons = {
          youtube: document.getElementById("tab-youtube"),
          facebook: document.getElementById("tab-facebook"),
          instagram: document.getElementById("tab-instagram"),
        };
        var pageTitle = document.getElementById("pageTitle");
        var urlLabel = document.getElementById("urlLabel");
        var urlInput = document.getElementById("url");
        var thumbContainer = document.getElementById("thumbnailContainer");
        var thumbImage = document.getElementById("thumbnailPreview");
        var form = document.getElementById("downloadForm");
        var downloadBtn = document.getElementById("downloadBtn");
        var titleContainer = document.getElementById("titleContainer");
        var titlePreview = document.getElementById("titlePreview");
        var messageDiv = document.getElementById("message");
        var clearBtn = document.getElementById("clearBtn");
        var overlay = document.getElementById("overlay");
        var progressBar = document.getElementById("downloadProgress");
        var progressText = document.getElementById("progressText");
        var formatContainer = document.getElementById("formatContainer");
        var overlayTitle = document.getElementById("overlayTitle");

        // Add event listeners to tab buttons for switching between platforms.
        Object.keys(tabButtons).forEach(function (key) {
          tabButtons[key].addEventListener("click", function () {
            // Prevent unnecessary updates if the same tab is clicked.
            if (activeTab === key) return;

            // Update active tab styling.
            tabButtons[activeTab].classList.remove(
              "text-blue-600",
              "border-blue-600"
            );
            tabButtons[activeTab].classList.add(
              "text-gray-600",
              "border-transparent"
            );
            tabButtons[key].classList.remove(
              "text-gray-600",
              "border-transparent"
            );
            tabButtons[key].classList.add("text-blue-600", "border-blue-600");

            // Update ARIA attributes for accessibility.
            tabButtons[activeTab].setAttribute('aria-selected', 'false');
            tabButtons[key].setAttribute('aria-selected', 'true');

            activeTab = key;
            var name = key.charAt(0).toUpperCase() + key.slice(1);
            var ext = key === "youtube" ? "MP3" : "MP4";
            pageTitle.textContent = name + " to " + ext + " (Web GUI)";
            urlLabel.textContent = name + " URL";

            // Update URL input placeholder based on active tab.
            if (key === "youtube") {
              urlInput.placeholder = "https://www.youtube.com/watch?v=...";
            } else if (key === "facebook") {
              urlInput.placeholder = "https://www.facebook.com/...";
            } else {
              urlInput.placeholder = "https://www.instagram.com/...";
            }
            urlInput.value = ""; // Clear URL input on tab switch.
            titleContainer.classList.add("hidden"); // Hide metadata containers.
            thumbContainer.classList.add("hidden");
            messageDiv.innerHTML = ""; // Clear messages.

            // Show/hide format selection based on tab (only YouTube has format options).
            if (key === "youtube") {
              formatContainer.classList.remove("hidden");
            } else {
              formatContainer.classList.add("hidden");
            }
          });
        });

        function fetchMetadata(url) {
          // Fetches video metadata (title and thumbnail) from the backend.
          fetch("/metadata", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: url }),
          })
            .then(function (resp) {
              // Check if the HTTP response was successful.
              if (!resp.ok) {
                // If not, parse the error message from the response body and reject the promise.
                return resp.json().then(err => Promise.reject(err));
              }
              return resp.json();
            })
            .then(function (data) {
              // Display video title if available.
              if (data.title) {
                titlePreview.textContent = data.title;
                titleContainer.classList.remove("hidden");
              } else {
                titleContainer.classList.add("hidden");
              }
              // Display video thumbnail if available.
              if (data.thumbnail) {
                thumbImage.src = data.thumbnail;
                thumbContainer.classList.remove("hidden");
              } else {
                thumbContainer.classList.add("hidden");
              }
            })
            .catch(function (error) {
              // Hide metadata containers on error.
              titleContainer.classList.add("hidden");
              thumbContainer.classList.add("hidden");
            });
        }

        // Event listener for URL input changes to fetch metadata dynamically.
        urlInput.addEventListener("input", function () {
          var val = urlInput.value.trim();
          var cleanUrl = val;
          var showMeta = false;
          // Validate URL format based on active tab to decide whether to fetch metadata.
          if (activeTab === "youtube") {
            var m = val.match(/(?:v=|youtu\.be\/|embed\/)([\w-]{11})/);
            if (m) {
              cleanUrl = "https://www.youtube.com/watch?v=" + m[1];
              showMeta = true;
            }
          } else if (activeTab === "facebook") {
            if (val.includes("facebook.com") || val.includes("fb.watch")) {
              showMeta = true;
            }
          } else if (activeTab === "instagram") {
            if (val.includes("instagram.com")) {
              showMeta = true;
            }
          }
          // Fetch metadata if URL is valid for the current tab.
          if (showMeta) {
            fetchMetadata(cleanUrl);
          } else {
            // Hide metadata if URL is not valid or empty.
            titleContainer.classList.add("hidden");
            thumbContainer.classList.add("hidden");
          }
          messageDiv.innerHTML = ""; // Clear previous messages.
        });

        // Event listener for form submission to start the download process.
        form.addEventListener("submit", function (e) {
          e.preventDefault(); // Prevent default form submission.
          var rawUrl = urlInput.value.trim();
          if (!rawUrl) return; // Do nothing if URL is empty.
          var sendUrl = rawUrl;
          // Clean YouTube URL for consistent backend processing.
          if (activeTab === "youtube") {
            var m2 = rawUrl.match(/(?:v=|youtu\.be\/|embed\/)([\w-]{11})/);
            if (m2) sendUrl = "https://www.youtube.com/watch?v=" + m2[1];
          }
          // Disable buttons and show overlay to prevent user interaction during download.
          downloadBtn.disabled = true;
          clearBtn.disabled = true;
          messageDiv.innerHTML = "";
          progressBar.value = 0;
          progressText.textContent = "0%";
          overlayTitle.textContent = "Downloading..."; // Initial overlay title.
          overlay.classList.remove("hidden");

          // Send download request to the backend.
          fetch("/download_start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              url: sendUrl,
              source: activeTab,
              format:
                activeTab === "youtube"
                  ? document.querySelector('input[name="format"]:checked').value
                  : "mp4",
            }),
          })
            .then(function (resp) {
              return resp.json();
            })
            .then(function (data) {
              // Handle errors returned from the backend.
              if (data.error) {
                messageDiv.textContent = "Error: " + data.error;
                overlay.classList.add("hidden"); // Hide overlay on error.
                downloadBtn.disabled = false;
                clearBtn.disabled = false;
                return;
              }
              var jobId = data.job_id; // Get the unique job ID for polling.
              // Start polling the progress endpoint at regular intervals.
              var poll = setInterval(function () {
                fetch("/progress/" + jobId)
                  .then(function (r) {
                    return r.json();
                  })
                  .then(function (statusData) {
                    // Handle errors during polling.
                    if (statusData.error) {
                      messageDiv.textContent = "Error: " + statusData.error;
                      clearInterval(poll); // Stop polling on error.
                      overlay.classList.add("hidden");
                      downloadBtn.disabled = false;
                      clearBtn.disabled = false;
                      return;
                    }
                    var p = statusData.progress || 0;
                    progressBar.value = p;
                    progressText.textContent = p + "%";

                    // Update overlay title based on the current stage of the download process.
                    if (statusData.stage === 'transcoding') {
                      overlayTitle.textContent = "Transcoding...";
                    } else if (statusData.stage === 'downloading') {
                      overlayTitle.textContent = "Downloading...";
                    } else {
                      overlayTitle.textContent = "Processing..."; // Fallback for other stages (e.g., queued).
                    }

                    // If download is complete, stop polling, hide overlay, and display download link.
                    if (statusData.status === "done") {
                      clearInterval(poll);
                      overlay.classList.add("hidden");
                      messageDiv.innerHTML = ""; // Clear previous messages.
                      var downloadLinkContainer = document.createElement('div');
                      downloadLinkContainer.className = "mt-4"; // Add margin top for spacing.
                      var link = document.createElement("a");
                      link.href = "/download_file/" + jobId;
                      // Apply button-like styling for better visibility and user experience.
                      link.className = "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 ease-in-out";
                      link.textContent = "Download File";
                      downloadLinkContainer.appendChild(link);
                      messageDiv.appendChild(downloadLinkContainer);
                      downloadBtn.disabled = false;
                      clearBtn.disabled = false;
                    }
                  });
              }, 500);
            })
            .catch(function () {
              // Handle network or unexpected errors during the fetch request.
              messageDiv.textContent = "Download failed.";
              overlay.classList.add("hidden");
              downloadBtn.disabled = false;
              clearBtn.disabled = false;
            });
        });

        // Event listener for the clear button to reset the form and UI.
        clearBtn.addEventListener("click", function () {
          urlInput.value = ""; // Clear URL input.
          titleContainer.classList.add("hidden"); // Hide metadata containers.
          thumbContainer.classList.add("hidden");
          messageDiv.innerHTML = ""; // Clear messages.

          // Reset format selection to MP3 for YouTube tab.
          if (activeTab === "youtube") {
            document.getElementById("format-mp3").checked = true;
          }
        });
      });
    </script>
  </body>
</html>
